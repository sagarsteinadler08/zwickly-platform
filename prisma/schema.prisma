generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  id                String   @id @db.Uuid
  title             String
  location          String?
  event_date        DateTime? @db.Date
  event_time        String?
  image_url         String?
  category          String?
  created_at        DateTime? @default(now())
  created_by        String?   @db.Uuid
  likes             Int?      @default(0)
  prosts            Int?      @default(0)
  description       String?   @db.Text
  language          String?
  registration_info String?

  @@map("events")
}

model Timetable {
  id         String   @id @db.Uuid
  day_name   String
  day_time   String
  course     String
  room       String?
  instructor String?
  cycle      String?
  sem_group  String?
  created_at DateTime? @default(now())
  updated_at DateTime? @default(now())

  @@map("timetable")
}

model WhzNews {
  id         String   @id @db.Uuid
  title      String
  description String?  @db.Text
  created_at DateTime? @default(now())

  @@map("whz_news")
}

model Exam {
  id         String   @id @db.Uuid
  course     String
  space      String?
  lecturer   String?
  date       String?
  period     String?
  sem_group  String?
  created_at DateTime? @default(now())
  updated_at DateTime? @default(now())

  @@map("exams")
}

model GermanCultureInteraction {
  id                 String   @id @db.Uuid
  situation          String
  culture_background String?
  german_behavior    String?  @db.Text
  interpretation     String?  @db.Text
  created_at         DateTime? @default(now())

  @@map("german_culture_interactions")
}

model MensaMenu {
  id              String   @id @db.Uuid
  meal_station    String?
  dish_description String?  @db.Text
  price_s         String?
  price_m         String?
  price_g         String?
  notes           String?
  created_at      DateTime? @default(now())

  @@map("mensa_menu")
}

model Item {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())

  @@map("items")
}

model PushSubscription {
  id        Int     @id @default(autoincrement())
  endpoint  String
  keys      Json?
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

model Profile {
  id        String   @id @db.Uuid
  email     String   @unique
  created_at DateTime? @default(now())

  @@map("profiles")
}

// User Management
model User {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  email         String   @unique
  password      String?  // Hashed password
  role          String   @default("student") // student, moderator, admin
  status        String   @default("active") // active, inactive, suspended
  lastLogin     DateTime?
  joinedDate    DateTime @default(now())
  profileImage  String?
  phone         String?
  studentId     String?  @unique
  sessions      Session[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
  @@index([email])
  @@index([role, status])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String   @db.Uuid
  device       String?
  browser      String?
  location     String?
  ipAddress    String?
  loginTime    DateTime @default(now())
  lastActivity DateTime @default(now())
  status       String   @default("active") // active, idle, expired
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@map("sessions")
  @@index([userId, status])
}

// Chat/Social Models
model Channel {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  slug        String    @unique
  description String?
  is_public   Boolean   @default(true)
  createdBy   String?
  createdAt   DateTime  @default(now())
  messages    Message[]
  requests    ChannelRequest[]
  polls       Poll[]

  @@map("channels")
}

model ChannelRequest {
  id          String   @id @default(uuid()) @db.Uuid
  channel     Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  channelId   String?  @db.Uuid
  name        String
  description String?
  requesterId String
  status      String   @default("pending")
  createdAt   DateTime @default(now())

  @@map("channel_requests")
}

model Message {
  id         String    @id @default(uuid()) @db.Uuid
  channel    Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId  String    @db.Uuid
  userId     String
  body       String    @db.Text
  imageUrl   String?
  isBot      Boolean   @default(false)
  createdAt  DateTime  @default(now())
  mentions   Mention[]
  pollVote   PollVote[]

  @@map("messages")
}

model Mention {
  id         String   @id @default(uuid()) @db.Uuid
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String   @db.Uuid
  userId     String
  createdAt  DateTime @default(now())

  @@map("mentions")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String
  type      String
  payload   Json
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("notifications")
}

model Poll {
  id          String   @id @default(uuid()) @db.Uuid
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId   String   @db.Uuid
  question    String
  options     Json
  isClosed    Boolean  @default(false)
  createdBy   String   @default("admin")
  createdAt   DateTime @default(now())
  votes       PollVote[]

  @@map("polls")
}

model Image {
  id           String   @id @default(uuid()) @db.Uuid
  channelId    String   @db.Uuid
  url          String
  originalName String?
  createdAt    DateTime @default(now())

  @@map("images")
}

model Ticket {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String
  channelId   String?  @db.Uuid
  messageId   String?  @db.Uuid
  title       String
  description String   @db.Text
  status      String   @default("open") // open, in_progress, resolved, closed
  priority    String   @default("normal") // low, normal, high, urgent
  category    String?  @default("general") // technical, academic, facilities, billing, other, general
  department  String?  @default("support") // it, admin, finance, facilities, academic, support
  assignedTo  String?  // admin user id
  adminReply  String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tickets")
  @@index([userId, status])
  @@index([status, category])
  @@index([department])
}

model PollVote {
  id        String   @id @default(uuid()) @db.Uuid
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  pollId    String   @db.Uuid
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  messageId String?  @db.Uuid
  optionId  String
  userId    String
  createdAt DateTime @default(now())

  @@unique([pollId, userId])
  @@map("poll_votes")
}

model Reminder {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String
  title         String
  description   String?  @db.Text
  reminderTime  DateTime
  completed     Boolean  @default(false)
  snoozedUntil  DateTime?
  recurrence    String?  // "once", "daily", "weekdays"
  source        String?  // "manual", "event", "study_plan", "calendar"
  sourceId      String?  // Reference to event/session if applicable
  timezone      String   @default("Europe/Berlin")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("reminders")
  @@index([userId, reminderTime])
  @@index([userId, completed])
}

// Pixi AI Cultural Knowledge Base
model CulturalInsight {
  id        String   @id @default(uuid()) @db.Uuid
  category  String   // tradition, bureaucracy, education, integration, language, events
  title     String
  content   String   @db.Text
  region    String   @default("Saxony") // Saxony, Germany, etc.
  tags      String[] // searchable keywords
  language  String   @default("en") // en, de
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cultural_insights")
  @@index([category])
  @@index([region])
  @@index([language])
}

// Pixi AI Conversation History
model PixiConversation {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String
  query     String   @db.Text
  response  String   @db.Text
  category  String?  // Detected topic category
  insights  String[] // IDs of cultural insights used
  rating    Int?     // 1-5 user rating
  createdAt DateTime @default(now())

  @@map("pixi_conversations")
  @@index([userId])
  @@index([category])
  @@index([createdAt])
}
